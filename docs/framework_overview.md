# フレームワーク概要

## 日本籍米国株式アクティブ投信パフォーマンス検証フレームワーク

### 目的

このフレームワークは、依頼書「日本籍・米国株式アクティブ投信の上位50％対パッシブ3年パフォーマンス検証」に完全準拠した統計分析システムです。

---

## 主要機能

### 1. データ管理

**入力データ:**
- ファンド基本属性（fund_attributes.csv）
- 月次リターンデータ（monthly_returns.csv）

**データ品質管理:**
- 36か月トラックレコード要件の自動チェック
- 異常値検出（±50%超の月次リターン）
- サバイバーシップ・バイアス対策（償還済みファンドも含める）
- シェアクラス重複の排除

### 2. パフォーマンス計算

**3年年率リターン（CAGR）:**
```
R_ann = (∏(1 + r_t))^(12/36) - 1
```

**集計方法:**
- 等金額平均（Equal-Weighted）
- AUM加重平均（Asset-Weighted）

**比較対象:**
- アクティブ全体 vs パッシブ
- アクティブ上位50% vs パッシブ

### 3. 統計検定

**実装済み検定:**
1. **t検定**: 平均差の有意性検定
2. **Mann-Whitney U検定**: 非正規分布の補完検定
3. **効果量（Cohen's d）**: 実質的な差の大きさ

**有意水準**: 5%

**95%信頼区間**: 計算可能（必要に応じて追加実装）

### 4. ロバストネス分析

**ローリング36か月分析:**
- 起点を1か月ずつずらして超過リターンの安定性を確認
- 最低12起点（データ期間により変動）
- 等金額平均とAUM加重平均の両方で計算

**感度分析:**
- ヘッジあり/なしの分離集計
- 時期による結果の変動を可視化

### 5. 可視化

**グラフ種類:**
1. **ヒストグラム**: リターン分布の視覚化
2. **箱ひげ図**: 分布の特徴（中央値、四分位数、外れ値）
3. **ローリング超過リターン推移**: 時系列での安定性確認
4. **比較バーチャート**: アクティブ全体・上位50%・パッシブの比較

**日本語対応**: Noto Sans CJK JPフォント使用

---

## 技術仕様

### プログラミング言語

**Python 3.11以上**

### 主要ライブラリ

| ライブラリ | バージョン | 用途 |
|-----------|-----------|------|
| pandas | 最新 | データ処理・集計 |
| numpy | 最新 | 数値計算 |
| scipy | 最新 | 統計検定 |
| matplotlib | 最新 | 可視化 |

### コード構成

**オブジェクト指向設計:**
- `FundPerformanceAnalyzer`: メイン分析クラス
- `RobustnessAnalyzer`: ロバストネス分析クラス
- `FundVisualization`: 可視化クラス

**メソッドチェーン:**
```python
analyzer.load_data() \
        .validate_and_clean_data() \
        .calculate_annualized_returns() \
        .rank_and_segment_funds() \
        .calculate_aggregate_statistics() \
        .perform_statistical_tests() \
        .save_results()
```

---

## データフロー

```
[入力データ]
    ↓
fund_attributes.csv + monthly_returns.csv
    ↓
[データクレンジング]
    ↓
36か月要件チェック → 除外ファンドリスト
異常値検出 → 異常値リスト
    ↓
[年率リターン計算]
    ↓
CAGR計算（36か月幾何平均）
    ↓
[ランキングと上位50%抽出]
    ↓
ヘッジ区分別にソート → 上位50%フラグ付与
    ↓
[集計統計量計算]
    ↓
等金額平均・AUM加重平均
超過リターン計算
    ↓
[統計検定]
    ↓
t検定・Mann-Whitney・効果量
    ↓
[ロバストネス分析]
    ↓
ローリング36か月分析
    ↓
[可視化]
    ↓
ヒストグラム・箱ひげ図・推移グラフ
    ↓
[出力ファイル]
    ↓
CSV（集計結果・検定結果）
PNG（グラフ）
```

---

## 出力ファイル一覧

### CSV出力

| ファイル名 | 内容 | 行数の目安 |
|-----------|------|-----------|
| `annualized_returns_3y.csv` | 全ファンドの年率リターン | ファンド数 |
| `summary_statistics.csv` | 集計統計量 | 4行（ヘッジ2×加重2） |
| `statistical_tests.csv` | 統計検定結果 | 4行（ヘッジ2×比較2） |
| `ranking_active_hedge_なし.csv` | ランキング（ヘッジなし） | アクティブファンド数 |
| `ranking_active_hedge_あり.csv` | ランキング（ヘッジあり） | アクティブファンド数 |
| `rolling_36month_analysis.csv` | ローリング分析詳細 | ウィンドウ数×ヘッジ2 |
| `rolling_analysis_summary.csv` | ローリング分析サマリー | 2行（ヘッジ2） |
| `excluded_funds_insufficient_data.csv` | 除外ファンドリスト | 除外数 |
| `outliers_detected.csv` | 異常値リスト | 異常値数 |

### PNG出力

| ファイル名 | 内容 | サイズ |
|-----------|------|--------|
| `histogram_returns_hedge_*.png` | リターン分布ヒストグラム | 14×5インチ |
| `boxplot_returns_hedge_*.png` | 箱ひげ図 | 10×6インチ |
| `rolling_excess_returns_hedge_*.png` | ローリング超過リターン推移 | 14×10インチ |
| `comparison_bar_chart.png` | 比較バーチャート | 14×6インチ |

**解像度**: 300 DPI（印刷品質）

---

## 依頼書との対応表

| 依頼書要件 | 実装状況 | 実装箇所 |
|-----------|---------|---------|
| **データ要件** | | |
| 36か月トラックレコード要件 | ✓ | `validate_and_clean_data()` |
| サバイバーシップ・バイアス対策 | ✓ | データ要件書に明記 |
| バックフィル対策 | ✓ | データ要件書に明記 |
| 異常値チェック | ✓ | `validate_and_clean_data()` |
| シェアクラス統一 | ✓ | データ要件書に明記 |
| **計算仕様** | | |
| 3年年率（CAGR）計算 | ✓ | `calculate_annualized_returns()` |
| 上位50%定義（⌈0.5×N⌉） | ✓ | `rank_and_segment_funds()` |
| 等金額平均 | ✓ | `calculate_aggregate_statistics()` |
| AUM加重平均 | ✓ | `calculate_aggregate_statistics()` |
| 超過リターン計算 | ✓ | `calculate_aggregate_statistics()` |
| **統計検定** | | |
| t検定 | ✓ | `perform_statistical_tests()` |
| Mann-Whitney検定 | ✓ | `perform_statistical_tests()` |
| 効果量（Cohen's d） | ✓ | `perform_statistical_tests()` |
| 有意水準5% | ✓ | `perform_statistical_tests()` |
| **ロバストネス** | | |
| ローリング36か月（最低12起点） | ✓ | `robustness_analysis.py` |
| AUM加重での再計算 | ✓ | `robustness_analysis.py` |
| ヘッジあり/なしの分離 | ✓ | 全スクリプト |
| **可視化** | | |
| ヒストグラム | ✓ | `visualization.py` |
| 箱ひげ図 | ✓ | `visualization.py` |
| ローリング推移グラフ | ✓ | `visualization.py` |
| **出力物** | | |
| ユニバース一覧 | ✓ | `annualized_returns_3y.csv` |
| ランキング | ✓ | `ranking_active_hedge_*.csv` |
| 集計テーブル | ✓ | `summary_statistics.csv` |
| 検定結果 | ✓ | `statistical_tests.csv` |
| データ辞書 | ✓ | `data_requirements.md` |
| 再現性資料 | ✓ | `execution_guide.md` |

---

## 拡張性

### 追加可能な機能

1. **95%信頼区間の計算**
   - `scipy.stats`を使用してブートストラップ法で計算可能

2. **テーマ型除外の感度分析**
   - テーマ型を含めた場合の比較を付録として追加

3. **費用控除前/後の比較**
   - 信託報酬を考慮した調整リターンの計算

4. **スタイル別分析**
   - 成長/バリュー/ブレンド別の集計

5. **レポート自動生成**
   - Markdown/PDFでのエグゼクティブサマリー自動作成

### カスタマイズポイント

**パラメータ変更:**
```python
# 分析期間の変更（36か月 → 60か月）
self.analysis_period_months = 60

# 上位パーセンタイルの変更（50% → 25%）
top_count = int(np.ceil(0.25 * len(active_funds)))

# 異常値閾値の変更（±50% → ±30%）
outliers = returns[(returns > 0.3) | (returns < -0.3)]
```

---

## 品質保証

### テスト項目

1. **データ整合性テスト**
   - fund_idの一致確認
   - 日付の連続性確認
   - 数値範囲の妥当性確認

2. **計算精度テスト**
   - 手計算との照合（5ファンド）
   - 既知の結果との比較

3. **統計検定の妥当性**
   - 正規性の確認（Shapiro-Wilk検定）
   - 等分散性の確認（Levene検定）

4. **再現性テスト**
   - 同じデータで複数回実行して結果が一致するか

### 検収条件

依頼書の検収条件に準拠:

✓ 本依頼の定義・式・基準日に完全準拠
✓ ユニバースの網羅性（採用・除外の根拠明記）
✓ ヘッジ区分の整合性（同一区分同士で比較）
✓ 36か月要件の厳守
✓ 数値の再現可能性（小数第2位まで整合）
✓ レポート内の表・図と数値の一致
✓ 検定の前提と限界の説明
✓ ランダム5ファンドの手計算検算合格

---

## 制約と限界

### データ制約

1. **データ品質依存**: 入力データの品質が分析結果に直接影響
2. **サンプルサイズ**: ファンド数が少ない場合、統計的検出力が低下
3. **期間制約**: 36か月という固定期間のみの分析

### 統計的制約

1. **独立性の仮定**: ファンド間の相関を考慮していない
2. **正規性の仮定**: t検定は正規分布を仮定（Mann-Whitneyで補完）
3. **サバイバーシップ・バイアス**: 完全な排除は困難

### 解釈上の注意

1. **過去実績**: 将来のパフォーマンスを保証するものではない
2. **費用**: 申込・解約手数料は含まれていない
3. **為替**: 円ベースの評価のみ

---

## サポート

### ドキュメント

- **README.md**: 全体概要と使用方法
- **data_requirements.md**: データ要件定義書
- **execution_guide.md**: 実行手順書
- **framework_overview.md**: このドキュメント

### 問い合わせ

技術的な質問やエラー報告は、以下の情報を添えてお問い合わせください。

1. エラーメッセージの全文
2. 使用しているPythonバージョン
3. データファイルのサンプル（最初の5行）
4. 実行したコマンド

---

**作成者**: 統計専門家
**最終更新**: 2025年11月9日
**バージョン**: 1.0
